---
title: "Trying reading netCDF directly"
output:
  html_document: default
  html_notebook: default
---

```{r message = FALSE, warning = FALSE}
library(dplyr)
```

Load the `ncdf4` package: 

```{r}
library(ncdf4)
```

Open an example historical output file:

```{r}
gfdl_hist <- nc_open("~/Downloads/tas_day_GFDL-ESM2G_historical_r1i1p1_19810101-19851231.nc")
print(gfdl_hist)
```

Try getting the location coordinates: 

```{r}
lon <- ncvar_get(gfdl_hist, "lon")
summary(lon)
```

Try getting latitude coordinates: 

```{r}
lat <- ncvar_get(gfdl_hist, "lat")
summary(lat)
```

Plot all coordinates:

```{r}
all_coords <- expand.grid(lon, lat) %>%
        rename(lon = Var1, lat = Var2) %>%
        mutate(lon2 = ifelse(lon > 180, -(360 - lon), lon))
head(all_coords)
```

```{r fig.width = 8, fig.height = 4}
library(ggplot2)
library(ggmap)
library(viridis)
ggplot() + 
        borders("world", colour="gray50", fill="gray50") + 
        geom_point(data = all_coords, aes(x = lon2, y = lat, color = lon),
                   size = 0.1) + 
        scale_color_viridis()
```

Get time from the file: 

```{r}
output_time <- ncvar_get(gfdl_hist, "time")
summary(output_time)
```

Get time units from attributes: 

```{r}
time_units <- ncatt_get(gfdl_hist, "time", "units")
time_units
```

Things seem a little off:

```{r}
as.Date(43800, origin = "1861-01-01")
```

```{r}
as.Date(45620, origin = "1861-01-01")
```

Pull some of the temperature values: 

```{r}
tas <- ncvar_get(gfdl_hist, "tas")
summary(tas)
```

This is in Kelvin: 

```{r}
ncatt_get(gfdl_hist, "tas", "units")
```

This has one measure for every latitude-longitude-time combination: 

```{r}
length(lon) * length(lat) * length(output_time) == length(tas)
```

```{r}
dim(tas)
```

```{r}
class(tas)
```

Here's an example map of temperature on the first day of this file:

```{r fig.width = 8, fig.height = 4}
library(weathermetrics)
all_coords %>% 
        mutate(tas_day = as.vector(tas[ , , 1]),
               tas_day = convert_temperature(tas_day, "k", "c")) %>%
        ggplot() + 
        borders("world", colour="gray50", fill="gray50") + 
        geom_point(aes(x = lon2, y = lat, color = tas_day),
                   size = 0.5) + 
        scale_color_viridis(name = "Temperature (C)")
```

Here's a plot for half-way through the first year (summer in the Northern Hemisphere):

```{r fig.width = 8, fig.height = 4}
library(weathermetrics)
all_coords %>% 
        mutate(tas_day = as.vector(tas[ , , 180]),
               tas_day = convert_temperature(tas_day, "k", "c")) %>%
        ggplot() + 
        borders("world", colour="gray50", fill="gray50") + 
        geom_point(aes(x = lon2, y = lat, color = tas_day),
                   size = 0.5) + 
        scale_color_viridis(name = "Temperature (C)")
```

Get some other metadata from the file:

```{r}
ncatt_get(gfdl_hist, 0, "title")
```

```{r}
ncatt_get(gfdl_hist, 0, "institution")
```

```{r}
ncatt_get(gfdl_hist, 0, "references")
```

```{r}
ncatt_get(gfdl_hist, 0, "history")
```

```{r}
ncatt_get(gfdl_hist, 0, "Conventions")
```

Try handling the time a different way, using the `ncdf.helpers` package: 

```{r}
library(ncdf4.helpers)
library(PCICt)
ts <- nc.get.time.series(gfdl_hist, v = "tas", time.dim.name = "time")
head(ts)
tail(ts)
```

This seems to work correctly for getting the times.

```{r}
class(ts)
```

```{r}
gfdl_dates <- as.Date(format(ts), "%Y-%m-%d %H:%M:%s")
summary(gfdl_dates)
```

Try using the `wux` package. Here is one of the example time series from CMIP5 data. It appears to be aggregated to the yearly level. 

```{r}
library(wux)
data("CMIP5_example_timeseries")
head(CMIP5_example_timeseries)
```

Try some of the functions in `RCMIP5`. It works for processing the file information: 

```{r}
library(RCMIP5)
getFileInfo("~/tmp")
```

```{r}
gfdl <- loadCMIP5("tas", "GFDL-ESM2G", "rcp85", path = "~/tmp/", yearRange = c(2071, 2072))
str(gfdl)
head(gfdl$time)
tail(gfdl$time)
```

Close the connection:

```{r}
nc_close(gfdl_hist)
```


```{r eval = FALSE}
library(ncdf4)
library(ncdf4.helpers)
library(PCICt)
library(readr)
library(dplyr)
library(tidyr)

gfdl_hist <- nc_open("~/Downloads/tas_day_GFDL-ESM2G_historical_r1i1p1_19860101-19901231.nc")
lon <- ncvar_get(gfdl_hist, "lon")
lat <- ncvar_get(gfdl_hist, "lat")
tas_time <- nc.get.time.series(gfdl_hist, v = "tas", time.dim.name = "time")
tas <- ncvar_get(gfdl_hist, "tas")
nc_close(gfdl_hist)

time_output <- data_frame(index = 1:length(tas_time),
                          time = format(tas_time, "%Y-%m-%d")) %>%
        separate(time, c("year", "month", "day")) %>%
        mutate(year = as.integer(year),
               month = as.integer(month),
               day = as.integer(day))
coordinate_output <- expand.grid(lon, lat) %>%
        rename("lon" = Var1) %>%
        rename("lat" = Var2) %>%
        select(lat, lon)
tas_output <- matrix(unlist(tas), 
                     ncol = length(lon) * length(lat),
                     byrow = TRUE) %>%
        as.data.frame()

write_csv(time_output, 
          path = "~/tmp/dataFolder/historical/GFDL/r1i1p1/time_day.csv",
          col_names = FALSE)
write_csv(coordinate_output, 
          path = "~/tmp/dataFolder/historical/GFDL/r1i1p1/latitude_longitude_day.csv", 
          col_names = FALSE)
write_csv(tas_output,
          path = "~/tmp/dataFolder/historical/GFDL/r1i1p1/tas_day.csv",
          col_names = FALSE)

city_file_location <- system.file("extdata/cities.csv",
                                 package = "futureheatwaves")
gen_hw_set(out = "~/tmp/example_results",
           dataFolder = "~/tmp/dataFolder",
           dataDirectories = list("historical" = c(1986, 1990),
                                  "rcp85" = c(2060, 2079)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_day.csv",
           tasFilenames = "tas_day.csv",
           timeFilenames = "time_day.csv",
           thresholdBoundaries = c(1986, 1990),
           projectionBoundaries = c(1986, 1990),
           referenceBoundaries = c(1986, 1990))

out <- "~/tmp/example_results"
apply_all_models(out = out, FUN = average_mean_temp,
                 city_specific = TRUE) %>% 
        mutate(value = convert_temperature(value, "k", "f"))

ex_results <- system.file("extdata/example_results",
                          package = "futureheatwaves")
apply_all_models(ex_results, FUN = average_mean_temp,
                 city_specific = TRUE) %>%
        mutate(value = convert_temperature(value, "k", "f"))
```

