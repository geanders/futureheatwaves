---
title: "`futureheatwaves` package vignette"
author: "G. Brooke Anderson and Colin Eason"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo = FALSE, message = FALSE}
library(futureheatwaves)
```

## What the package does

The `futureheatwaves` package can process climate data files that you have stored locally to generate a list of heatwaves in each projection as well as characteristics of each heatwave (e.g., length, intensity, timing in the year). The package generates community-specific dataframes based on an input file listing each community and its latitude and longitude. Files with the heatwaves identified and characterized under each ensemble member of each climate model are output as files in a directory specified by the user.

## A basic example of using the package

For these functions to work correctly, you must have the climate projections saved in a specific structure locally on your computer. An example of a directory with the required set-up is given as the `cmip5` directory in the `inst` directory of this package.

You must have a directory that has within it separately subdirectories names "rcp85" and "historical" that contain, respectively, all files drawn from projections for future dates ("rcp85") and all for dates up to 2005 ("historical"). Within each of these subdirectories, you need a subdirectory for each climate model. Within each climate model directory, you need subdirectories for each ensemble member of the model (even if the model only has one ensemble member). Within each ensemble-member directory, you will need three comma-separated files: one file with the climate model output, with columns corresponding to climate grid point and rows corresponding to time, one file that gives the time values corresponding to each row in the climate model output file, and one file giving the latitude and longitude corresponding to the grid locations used in the columns of the climate model output file. 

Throughout the directory, subdirectories should be named using names reflecting the climate model or ensemble members they contain. The output files will be written using the same type of directory structure and the same names, so this output will be easier to interpret and use if the directory uses meaningful names for subdirectories. 

Once you have your files set up in this structure, define the following variables: 

- `dataFolder`: Character string with pathway to directory that contains climate projections. 
- `citycsv`: Character string giving the filepath to a .csv file with latitude and longitude values for each city for which you would like to generate
heatwave projections.
- `coordinateFilenames`: Character string with name of the files containing the latitude and longitude coordinates corresponding to the columns of the time series data.
- `tasFilenames`: Character sting with name of files containing the time series data.
- `timeFilenames`: Character string with name of the files containing the date information corresponding to the rows of the time series data.

For example, if I had a directory called `cmip5` with the projection data and a file called `citycsv` with the community list and locations, both in the directory `inst`, I would specify `dataFolder` and `citycsv` as: 

```{r}
dataFolder <- "inst/cmip5/" 
citycsv <- "inst/cities.csv"
```

Within the ensemble subdirectories in my files structure, all of the files with climate model data are named "tas_NorthAmerica_12mo.csv", all the files with the corresponding time for rows in that data are in files named "time_NorthAmerica_12mo.csv", and all the files with locations of the grid points are named "latitude_longitude_NorthAmerica_12mo.csv". Therefore, I would specify: 

```{r}
coordinateFilenames <- "latitude_longitude_NorthAmerica_12mo.csv"
tasFilenames <- "tas_NorthAmerica_12mo.csv"
timeFilenames <- "time_NorthAmerica_12mo.csv"
```

You will also need to specify where the output files should be locally saved. Save this as the object `out`. For example, if I wanted to write the output heatwave files to a directory called "example_results" in the `tmp` subdirectory of my home directory, I could specify:

```{r}
out <- "~/tmp/example_results/"
```

These selections will be sufficient to run the main function of this package, `gen_hw_set`, using a basic example with default values for things like the heatwave definition, years for which to generate the heatwave datasets (default is 2061--2080), and years to use as a reference for the relative temperature characteristics measured for the heatwaves (default is ...).

Once you have specified these values, you can create files with future heatwaves and their characteristics using the following code:

```{r eval = FALSE}
gen_hw_set(out = out,
           dataFolder = dataFolder,
           citycsv = citycsv,
           coordinateFilenames = coordinateFilenames,
           tasFilenames = tasFilenames,
           timeFilenames = timeFilenames,
           RorCPP = 0)
```

You will first be asked: 

```
Warning: This function will write new files to your computer in the  
 ~/tmp/results directory of your computer. 
 Do you want to continue (y / n): 
```

This warning reminds you that this function will create subdirectories and write out files to the directory you specified when defining `out`. If you agree that it is okay to write files and subdirectories to this directory, enter "y" at the prompt, and the function will continue running. 

If your file structure is set up correctly, you should get output that looks like this:

```
Processing historical ensemble for bcc1 
Reading ---> r1i1p1 
Read operation complete 
Processing rcp 8.5 ensemble bcc1 
Reading ---> r1i1p1 
Read operation complete 
Creating heatwave dataframe ~~ City:  balt  ~~ City Number:  1  ~~ Cutoff:  84.632 
Creating heatwave dataframe ~~ City:  ny  ~~ City Number:  2  ~~ Cutoff:  78.77876 
Creating heatwave dataframe ~~ City:  nwk  ~~ City Number:  3  ~~ Cutoff:  78.77876 
Creating heatwave dataframe ~~ City:  phil  ~~ City Number:  4  ~~ Cutoff:  84.632 
Creating heatwave dataframe ~~ City:  prov  ~~ City Number:  5  ~~ Cutoff:  75.074 
Writing bcc1: r1i1p1
Writing accumulator 
All operations completed. Exiting. 

  modelName length.histens. length.rcpens.
1      bcc1               1              1
```

The function provides status reports on its progress in generating the heatwave projections, as this process can take a while if you include many cities and / or many climate model projections. If you do not want to generate this output when running the function, choose the option `printWarning = FALSE` when calling `gen_hw_set`.

Once the function has completed running, you will have two new subdirectories in the directory you specified with the `out` variable. These will be called `Heatwaves` and `Thresholds`. The `Heatwaves` directory will contain dataframes with all identified heatwaves and their characteristics for each city, while the `Thresholds` folder will contain files with the temperature thresholds used for each city given. The `out` directory specified will also have a file called `hwModelInfo.csv` that contains some basic information about the climate models and the number of ensemble members included for each.

## Example data

We used, as an example, data from the Beijing Climate Center, China Meteorological Administration model projections included in CMIP5. See: [this link](http://cmip-pcmdi.llnl.gov/cmip5/availability.html). 
)

The data for this example of includes climate projections for grid points near several major East Coast cities: New York, NY; Philadelphia, PA; Newark, NJ; Baltimore, MD, Providence, RI. For the example CMIP5 data we used, all of these communities could be linked to three grid points on the climate model.

The historical projections range over the years 1980 to 2005, while the future projections range over the years 2006 to 2099.

Here is an example of the first few lines of a `times` file for historical projection data: 

```{r echo = FALSE}
my_dir <- system.file("cmip5", package = "futureheatwaves")
my_file <- paste0(my_dir, "/", 
                    "historical/bcc1/r1i1p1/time_NorthAmerica_12mo.csv")
times <- read.csv(my_file, header = FALSE)
head(times, 4)
```

Here is an example of the first few lines of a `latlong` file for historical projection data: 

```{r echo = FALSE}
my_file <- paste0(my_dir, "/", 
                    "historical/bcc1/r1i1p1/latitude_longitude_NorthAmerica_12mo.csv")
latlongs <- read.csv(my_file, header = FALSE)
head(latlongs, 4)
```

Here is an example of the first few lines of a `tas` file for historical projection data for the three grid points that are included in our examples in the package documentation: 

```{r echo = FALSE}
my_file <- paste0(my_dir, "/", 
                    "historical/bcc1/r1i1p1/tas_NorthAmerica_12mo.csv")
tas2 <- read.csv(my_file, header = FALSE)
head(tas2, 4)
```


## Using custom options

### Using a custom heatwave definition

The default is for this package to use the following definition to identify heatwaves: 

> A heatwave is two or more days at or above a community-specific threshold temperature, with the threshold determined as the $98^{th}$ percentile of year-round temperature in the community during some reference period (by default, 1981--2004).

Two components of this definition can be customized directly. 

First, the percentile used to identify a heatwave can be changed using the `probThreshold` option when calling the `gen_hw_set` function. This option can take values between 0 and 1. The default value is 0.98, or a definition with a threshold of the $98^{th}$ percentile of the community's temperature.

Second, it is possible to specify the range of years of data for the community that should be used when determining this threshold. For example, if you wanted to base the threshold for each community on current community climates, you could leave this option as its default, which uses climate projections from the years 1981 to 2004 to determine the thresholds. If you wanted to use a different set of years, you could set the start and end year
bounds for this reference period within the first two values of the option `dataBoundaries` in the function `gen_hw_set`.

It is also possible to use a completely customized heatwave definition. To do this, you will need to load a function, implementing the definition to identify heatwaves in a time series of temperature data, into your R session. You can then reference the custom function using the `IDheatwavesReplacement` option in `gen_hw_set`.

To work correctly, this custom function for identifying heatwaves must allow specific inputs and generate specific outputs. The function must allow the following inputs (even if it does not use them within the function code):

...

The function most generate the following output: 

...


## How it works

### Parsing the directory structure

After some preliminary checks, the function reads in the structure of the directory specified by `dataFolder` and uses the names of subdirectories to create a list of all of the climate models and their ensemble members within the directory. 

The function that does this parsing, `acquireDirectoryStructure`, returns a list object outlining the file structure of the directory containing the climate projections.This list has an element for each climate model (e.g. ,"bcc1"). The first element within each of these elements is the name of the model. The second element within the first-level element gives the file paths for location grids, climate projections, and projection times for each ensemble run of the model.

For example: 

```{r}
dataFolder <- system.file("cmip5", package = "futureheatwaves")
finalList <- acquireDirectoryStructure(dataFolder = dataFolder,
   coordinateFilenames = coordinateFilenames,
   tasFilenames = tasFilenames,
   timeFilenames = timeFilenames)

finalList[[1]][[1]]
finalList[[1]][[2]][1]
```

This parsed version of the directory structure helps the following functions walk through all of the climate projections for different models and ensembles within the specified projections directory.

### Aggregating heatwave projections

Once the function has generated a list describing the climate models and ensemble members included in the user-specified `dataFolder` directory of climate projections, the function will run through all ensemble members of any climate model within this directory, identify and characterize the heatwaves for that ensemble member, and save the resulting dataframe to output. 

The package uses closures to aggregate data over all the different ensemble members of all climate models included in the directory of projection data ...

### Determining thresholds for heatwave definition

To determine the threshold value for each community, the function pulls climate projection data from either the default historical years (1981--2004) or from a customized range of dates, as specified by the first two values in the `dataBoundaries` option for the `gen_hw_set` function. This option allows the user to select years in the recent past to use when determining these threshold temperatures. [Can we use future years for this, too?]

All climate projection data for the grid point closest to each community is pulled and use to estimate the community-specific thresholds. The percentile value calculated for each community is either a default of 0.98 or is specified by the user using the `probThreshold` option in the `gen_hw_set` function.

These community-specific thresholds are then passed through to later calls in the function, where they are used to identify heatwaves in a time series of climate projection data. 

### Creating ensemble-member specific projections
