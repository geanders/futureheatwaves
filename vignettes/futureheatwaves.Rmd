---
title: "`futureheatwaves` package vignette"
author: "G. Brooke Anderson, Colin Eason, and Elizabeth Barnes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
references:
- id: gent2011 
  title: The Community Climate System Model Version 4
  author: 
  - family: Gent 
    given: Peter R.
  - family: Danabasoglu 
    given: Gokhan
  - family: Donner
    given: Leo J. 
  - family: others
  container-title: Journal of Climate
  volume: 24
  DOI: 10.1175/2011JCLI4083.1
  page: 4973-4991
  type: article-journal
  issued: 
    year: 2011
- id: smith2013
  title: "Heat waves in the United States: definitions, patterns and trends"
  author: 
  - family: Smith
    given: Tiffany T 
  - family: Zaitchik
    given: Benjamin F
  - family: Gohlke
    given: Julia M
  container-title: Climatic Change
  volume: 118
  DOI: 10.1007/s10584-012-0659-2
  page: 811-825
  type: article-journal
  issued: 
    year: 2013
- id: taylor2012
  title: An Overview of CMIP5 and the Experiment Design
  author: 
  - family: Taylor
    given: Karl E.
  - family: Stouffer
    given: Ronald J.
  - family: Meehl
    given: Gerald A.
  container-title: Bulletin of the American Meteorological Society
  volume: 93
  DOI: 10.1175/BAMS-D-11-00094.1
  page: 485â€“498
  type: article-journal
  issued: 
    year: 2012
- id: xin2013
  title: Introduction of CMIP5 experiments carried out with the climate system models of Beijing Climate Center
  author:
  - family: Xin
    given: Xiao-Ge
  - family: Wu
    given: Tong-Wen
  - family: Zhang
    given: Jie
  container-title: Advances in Climate Change Research
  volume: 4
  DOI: 10.3724/SP.J.1248.2013.041
  issue: 1
  page: 41-49
  type: article-journal
  issued:
    year: 2013
---

```{r echo = FALSE, message = FALSE}
library(futureheatwaves)
```

## What the package does

Often, it is of interest in climate impact research to explore impact estimates for climate projections from many different climate models, some of which have multiple ensemble members. The scope of this data means that researchers often must spend a lot of time writing code scripts to process the data from different climate models or ensemble members. This is the case, for example, in studying the climate impacts of heatwaves, since multi-day heatwave events must be indentified and characterized for each climate model and ensemble member before impacts can be estimated. We have created this package to automate this process in a way that still allows extensive customization by the user in choices like how to define a heatwave. 

The `futureheatwaves` package can process climate files, which are stored locally on your computer, to generate a list of the heatwaves in each projection as well as characteristics of each heatwave (e.g., length, intensity, timing in the year). You can identify heatwaves based either on a default definition (two or more days with temperatures at or above the community's $98^{th}$ percentile of year-round temperature), or you can write your own R function to use any heatwave definition of your choice, or to explore several heatwave definitions. The package identifies community-specific heatwaves, based on an input file listing each community and its latitude and longitude. of each climate model are output as files in a directory specified by the user.

Once you create these dataframes of community-specific heatwaves, another function in the package allows you to apply custom functions across all the heatwave dataframes that were generated. This functionality can be used to generate summary statistics (e.g., determine average heatwave length or total heatwave days), or can be used to apply more complex functions (e.g., apply epidemiologic effect estimates across the heatwaves to generate health impact estimates).

This package does require some pre-processing, in terms of getting climate projection data into a specific format and storing files in a specific directory structure. However, once the user has completed this pre-processing and directory set-up, the package allows the user to quickly process through data from many projections, generate heatwave datasets for each, and apply custom functions across each heatwave definition.

This package requires you to have data on community locations and climate projection data set up in a specific way on your local computer. You then use arguments in the main package function, `gen_hw_set`, to direct the function to these files so it can process them and output heatwave projections. The final projection files will be written out to your local computer, in a directory that you select and specify through `gen_hw_set`. You can then apply user-created R functions to all heatwaves in the output using the `apply_all_models` function.

## A basic example of using the package

### Example data

We have included data files in the package to serve as example files so users can try out this package before applying it to their own directories. The files are all included as comma-separated files, rather than as saved R objects, to allow users to see how to create the appropriate directory set-up for this package. 

We used, as an example, data from two climate models used for the fifth Coupled Model Intercomparison Project (CMIP5) [@taylor2012]: (1) the model of the Beijing Climate Center, China Meteorological Administration (BCC) [@xin2013] and (2) the National Center for Atmospheric Research's (NCAR's) Community Climate System Model (CCSM4) [@gent2011]. We include one ensemble member from BCC (r1i1p1) and two from CCSM (r1i1p1 and r2i1p1).

To ensure that the size of this example data is reasonably small, we have only included projection data for model grid points near several major East Coast cities: New York, NY; Philadelphia, PA; Newark, NJ; Baltimore, MD, Providence, RI. Further, to keep the file sizes reasonably small, the historical projections range over the years ... to ..., while the future projections range over the years ... to ... .

These location of these files within the downloaded package be determined using  `system.file`: 

```{r}
system.file("cities.csv", package = "futureheatwaves")
```

In the later sections of this vignette, we show how to use the package functions with these example files as inputs. 

### Required files and directory set-up

#### File with community locations

First, you must have a comma-separated (csv) file the gives unique identifiers for each community for which you wish to make projections, as well as their latitude and longitude. The latitude and longitude should be expressed in the same way that latitude and longitude are expressed in the climate projection files to be processed (e.g., if latitude for New York City is expressed as 286 in the climate projection files, it cannot be expressed as -74 or 74 W in the community file). The community location file should have three columns, with the following column names: 

- `city`: A unique identifier for each community you will be analyzing.
- `lat`: The communities' latitudes
- `lon`: The communities' longitudes

Here is an example of the correct format for a community locations file for five US communities (Baltimore, MD; New York, NY; Newark, NJ; Philadelphia, PA; and Providence RI):

```
"city","lat","lon"
"balt",39.3008,283.3894
"ny",40.6698,286.0562
"nwk",40.7241,285.8268
"phil",40.006817,284.8653
"prov",41.82195,288.5803
```

You will specify the location of this community locations file within your computer file directory when running the main function (`gen_hw_set`) by using the argument `citycsv`. For example, if I had this file saved as "my_cities.csv" in my working directory, I would specify `citycsv = "my_cities.csv"` in the `gen_hw_set` function call. You can use either absolute or relative filepaths in this argument. 

If your community locations file has different column names for the latitude and longitude columns, you can specify this using the `lat_lon_colnames` argument in `gen_hw_set`. For example, if these columns were named "latitude" and "longitude", you could specify `lat_lon_colnames = c("latitude", "longitude")` when calling `gen_hw_set`.


#### Directory structure for climate projection files

For these functions to work correctly, you must have climate projection files saved in a specific structure locally on your computer. An example of a directory with the required set-up is given as the `cmip5` directory that comes installed with this package. To identify the location on your own computer of this directory, you can run:

```{r}
system.file("cmip5", package = "futureheatwaves")
```

You must have a directory that has within it separately subdirectories names "rcp85" and "historical" that contain, respectively, all files drawn from projections for future dates ("rcp85") and all for dates up to 2005 ("historical"). Within each of these subdirectories, you need a subdirectory for each climate model. Within each climate model directory, you need subdirectories for each ensemble member of the model (even if the model only has one ensemble member). Within each ensemble-member directory, you will need three comma-separated files: one file with the climate model output, with columns corresponding to climate grid point and rows corresponding to time, one file that gives the time values corresponding to each row in the climate model output file, and one file giving the latitude and longitude corresponding to the grid locations used in the columns of the climate model output file. 

For example, the following shows the file structure for the files in the example data included with the package. This example directory includes separate historical (with years 1980--2004) and RCP8.5 (with years 2006--2099) directories, each of which has the required climate projection, grid point locations, and projection time files for two separate models (`bcc1` and `ccsm`) with one and two separate ensemble members, respectively(`r1i1p1` for `bcc1`; `r1i1p1` and `r2i1p1` for `ccsm`). The user specifies that name and location of the directory (through the `dataFolder` option in `gen_hw_set`) as well as the names and year ranges of the two subdirectories (through the `dataDirectories` option in `gen_hw_set`; e.g., `dataDirectories = list("historical" = c(1980, 2004), "rcp85" = c(2006, 2099))` if the two subdirectories have the names "historical" and "rcp85").

- `cmip5`
    - `historical`
        - `bcc1`
            - `r1i1p1`
                - `tas_NorthAmerica_12mo.csv`
                - `latitude_longitude_NorthAmerica_12mo.csv`
                - `time_NorthAmerica_12mo.csv`
        - `ccsm`
            - `r1i1p1`
                - `tas_NorthAmerica_12mo.csv`
                - `latitude_longitude_NorthAmerica_12mo.csv`
                - `time_NorthAmerica_12mo.csv`
    - `rcp85`
        - `bcc1`
            - `r1i1p1`
                - `tas_NorthAmerica_12mo.csv`
                - `latitude_longitude_NorthAmerica_12mo.csv`
                - `time_NorthAmerica_12mo.csv`
        - `ccsm`
            - `r1i1p1`
                - `tas_NorthAmerica_12mo.csv`
                - `latitude_longitude_NorthAmerica_12mo.csv`
                - `time_NorthAmerica_12mo.csv`
            - `r2i1p1`
                - `tas_NorthAmerica_12mo.csv`
                - `latitude_longitude_NorthAmerica_12mo.csv`
                - `time_NorthAmerica_12mo.csv`

Notice that each subdirectory has all required levels-- for example, even though the `bcc1` model only has one ensemble member (in this example), we've still included a directory level for ensembles in the directory structure. Also notice that the final subdirectory always includes three files (with climate projections, grid point locations, and times; these files are explained in the next section), even if multiple ensemble members of the same climate model share the same grid point locations or times. 

Throughout the directory, subdirectories should be named using names reflecting the climate model they contain. The output files will be written using the same type of directory structure and the same names, so this output will be easier to interpret and use if the directory uses meaningful names for subdirectories. 

Once you have your files set up in this structure, you will specify the location of the start of the directory using the `dataFolder` argument in the `gen_hw_set` function. In the example directory structure above, if the `cmip5` directory was in your current working directory, you would specify `dataFolder = "cmip5"` when calling `gen_hw_set`. 

#### Files with climate projections

For each ensemble member of each climate model, you must have three files: one giving the gridded climate model output by date, one giving the location of each of the climate model grids, and one giving the date of each of the climate model projections. 

These files must be in a certain structure to run correctly through the `gen_hw_set` function. Therefore, the function currently requires a certain amount of preprocessing of climate projection files from a format like .`netCDF` to prepare them to go through this function. In the future, we plan to extend this package to allow the `gen_hw_set` function to directly process `.netCDF` files. In the meantime, you must preprocess the file for the projection from each ensemble member to conform to the formats listed below. 

**Climate projection file**: The climate projection file should be a comma-separated file of temperatures (in Kelvin) that looks something like this:

```
"275.74","282.32","285.03"
"275.94","283.14","285.47"
"272.9","280.26","284.6"
"273.61","280.82","284.67"
"273.97","281.18","284.83"
```

This is a projection file covering three grid points of a climate model, giving projections for five dates. Each column corresponds to one grid point in the climate model. Each row corresponds to one date. The file does not have a header row; rather, the observations begin immediately on the first row of the file. Similarly, the file does not have a column of row numbers. Most projection files will include many more columns and rows than this small example, since they will usually cover all the grid points in a climate model and a long time series of observations.

In the current version of this package, these projection files must not have gaps in dates and cannot have any missing observations. Each climate model ensemble member will need to have a climate projection file like this one. They will all be saved in separate, ensemble-specific directories and should all be given the same file name. In our example data, these climate projection files are always saved with the filename "tas_NorthAmerica_12mo.csv". You will need to specify this filename in the `tasFilenames` argument when running `gen_hw_set`.

**Grid point location file**: The grid point location file should be a comma-separated file that looks something like this:

```
"40.464","284.06"
"40.464","286.88"
"40.464","289.69"
```

For this file, each row gives the location for the grid point for the corresponding column in the climate projection files. For example, the first row gives the latitude (first column) and longitude (second column) for the projections given in the first column of the climate projection file, the second row of this file gives the latitude and longitude for the projection given in the second column of the climate projection file, and so on. 

The first column of this file should give latitude and the second column should give longitude. The file should not have a header row or a separate column of row names. 

Each climate model ensemble member will need to have a grid-point location file like this one. They will all be saved in separate, ensemble-specific directories and should all be given the same file name. In our example data, these grid-point location files are always saved with the filename "latitude_longitude_NorthAmerica_12mo.csv". You will need to specify this filename in the `coordinateFilenames` argument when running `gen_hw_set`.

**Projection times data file**: The projection times data file should be a comma-separated file that looks something like this:

```
"0","2006","1","1"
"1","2006","1","2"
"2","2006","1","3"
"3","2006","1","4"
"4","2006","1","5"
```

This file gives a date that corresponds to each row of the climate projection file. The file should have four columns: one with row numbers, and then one each with year, month, and day. Year should be given with four digits. The file should not have a header row. 

Each climate model ensemble member will need to have a separate projection times data file like this one. They will all be saved in separate, ensemble-specific directories and should all be given the same file name. In our example data, these grid-point location files are always saved with the filename "time_NorthAmerica_12mo.csv". You will need to specify this filename in the `timeFilenames` argument when running `gen_hw_set`.

#### Specifying where to output results

You will need to select a directory pathname where all the heatwave projection files generated by the function will be saved. For example, if you wanted to create a new directory called "example_results" in the current working directory and output files there, you could specify `out = "example_results"` in `gen_hw_set`. If you use a pathname to a directory that does not yet exist, the function will create that directory and then write the results to it. If you specify a directory that does already exist, the function will overwrite it with the results from the function run. You therefore should be careful when specifying this directory path and be sure to confirm that the function will not overwrite a directory you do not want to lose. You will specify the output directory using the `out` argument in the `gen_hw_set` function. 

### Running the code to generate heatwave datasets

These selections will be sufficient to run the main function of this package, `gen_hw_set`, using a basic example with default values for things like the heatwave definition and years for which to generate the heatwave datasets (default is 2061--2080; further default values and ways to customize are fully explained in a later section).

If you are happy with these defaults, you can create files with future heatwaves and their characteristics by calling `gen_hw_set`. For example, if you wanted to use the example city location and climate projection data, and save results to a directory called "example_results" in your current working directory, you could run:

```{r eval = FALSE}
projection_dir_location <- system.file("cmip5", package = "futureheatwaves")
city_file_location <- system.file("cities.csv", package = "futureheatwaves")

gen_hw_set(out = "example_results",
           dataFolder = projection_dir_location ,
           dataDirectories = list("historical" = c(1980, 2004),
                                        "rcp85" = c(2006, 2099)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_NorthAmerica_12mo.csv",
           tasFilenames = "tas_NorthAmerica_12mo.csv",
           timeFilenames = "time_NorthAmerica_12mo.csv",
           lat_lon_colnames = c("lat", "long"))
```

Notice that, in this call, you must specify the directory where you would like results written (`out`), the location of the directory of climate projections (`dataFolder`), the names of the two main subdirectories of that climate projection directory, as well as their year boundaries (`dataDirectories`), the file name of the community location file (`citycsv`), and the names used for the final grid coordinate, climate projection, and projection date files (`coordinateFilenames`, `tasFilenames`, and `timeFilenames`). In this example, the `lat_lon_colnames` is also required, because the community locations file uses the column name "long", rather than the default "lon", to specify the longitude column.

When you run this call, you will first be advised that the function will write files to your computer, and you will need to confirm that you want to proceed: 

```
 Warning: This function will write new files to your computer in the 
 ~/tmp/results/ directory of your computer. If that directory already exists,
running this function will write over it. 
 Do you want to continue? (y / n): 
```

This warning reminds you that this function will create subdirectories and write out files to the directory you specified when defining `out`. If you agree that it is okay to write files and subdirectories to this directory, enter "y" at the prompt, and the function will continue running. (If you do not want to get this warning when running the function-- for example, when looping and calling this function repeatedly-- choose the option `printWarning = FALSE` when calling `gen_hw_set`.)

If your file structure is set up correctly, you should get output that looks like this:

```
Processing thresholds for bcc1 
Reading ---> r1i1p1 
Read operation complete 
Processing projections for  bcc1 
Reading ---> r1i1p1 
Read operation complete 
Creating heatwave dataframe ~~ City:  balt  ~~ City Number:  1  ~~ Cutoff:  84.632 
Creating heatwave dataframe ~~ City:  ny  ~~ City Number:  2  ~~ Cutoff:  78.77876 
Creating heatwave dataframe ~~ City:  nwk  ~~ City Number:  3  ~~ Cutoff:  78.77876 
Creating heatwave dataframe ~~ City:  phil  ~~ City Number:  4  ~~ Cutoff:  84.632 
Creating heatwave dataframe ~~ City:  prov  ~~ City Number:  5  ~~ Cutoff:  75.074 
Writing bcc1: r1i1p1
Processing thresholds for ccsm 
Reading ---> r1i1p1 
Read operation complete 
Processing projections for  ccsm 
Reading ---> r1i1p1 
Read operation complete 
Creating heatwave dataframe ~~ City:  balt  ~~ City Number:  1  ~~ Cutoff:  82.36076 
Creating heatwave dataframe ~~ City:  ny  ~~ City Number:  2  ~~ Cutoff:  79.55276 
Creating heatwave dataframe ~~ City:  nwk  ~~ City Number:  3  ~~ Cutoff:  79.55276 
Creating heatwave dataframe ~~ City:  phil  ~~ City Number:  4  ~~ Cutoff:  80.474 
Creating heatwave dataframe ~~ City:  prov  ~~ City Number:  5  ~~ Cutoff:  79.34 
Writing ccsm: r1i1p1
Processing projections for  ccsm 
Reading ---> r2i1p1 
Read operation complete 
Creating heatwave dataframe ~~ City:  balt  ~~ City Number:  1  ~~ Cutoff:  82.36076 
Creating heatwave dataframe ~~ City:  ny  ~~ City Number:  2  ~~ Cutoff:  79.55276 
Creating heatwave dataframe ~~ City:  nwk  ~~ City Number:  3  ~~ Cutoff:  79.55276 
Creating heatwave dataframe ~~ City:  phil  ~~ City Number:  4  ~~ Cutoff:  80.474 
Creating heatwave dataframe ~~ City:  prov  ~~ City Number:  5  ~~ Cutoff:  79.34 
Writing ccsm: r2i2p2
Writing accumulators 
All operations completed. Exiting.
```

The function provides status reports on its progress in generating the heatwave projections. This helps you see that the function call is progressing, as this process can take a while if you include many cities and / or many climate model projections. 

Once the function has completed running, you will have one new subdirectory in the `out` directory you specified called "Heatwaves". This directory will contain dataframes with all identified heatwaves and their characteristics for each ensemble member of each climate model in your original directory. The `out` directory specified will also have a file called `hwModelInfo.csv` that contains some basic information about the climate models and the number of ensemble members included for each as well as `locationList.csv`, a file that gives the closest model gridpoint to each community for each climate model, and `hwModelInfo.csv`, a file that lists each of the climate models and the number of ensemble members for each within each subdirectory (e.g., "historical" and "rcp85" for the example).

The full output directory structure will look something like this: 

- `out`
    - `Heatwaves`
        - `Projections`
            - `bcc1`
                - `1.csv`
            - `ccsm`
                - `1.csv`
                - `2.csv`
    - `hwModelInfo.csv`
    - `locationList.csv`
    
Each of the heatwave files will have one heatwave per row, covering all the heatwaves identified for that particular ensemble member. The dataframe has the following columns with characteristics of each heatwave: 

Column name | Description
----------- | --------------
`hw.number` | A sequential number identifying each heatwave in each community
`mean.temp` | Average of mean daily temperature across all days in the heatwave
`max.temp` | Highest value of mean daily temperature across days in the heatwave
`min.temp` | Lowest value of mean daily temperature across days in the heatwave
`length` | Number of days in the heatwave
`start.date` | Date of the first day of the heatwave 
`end.date` | Date of the last day of the heatwave 
`start.doy` | Numeric day of the year of the first day of the heatwave (1 = Jan. 1, etc.)
`start.month` | Numeric value indicating the month in which the heatwave started (1 = January) 
`days.above.80` | Number of days in the heatwave above 80 degrees Fahrenheit 
`days.above.85` | Number of days in the heatwave above 85 degrees Fahrenheit 
`days.above.90` | Number of days in the heatwave above 90 degrees Fahrenheit
`days.above.95` | Number of days in the heatwave above 90 degrees Fahrenheit
`days.above.99th` | Number of days in the heatwave above the 99th percentile temperature for the community, using the period specified by the user with the `referenceBoundaries` argument in `gen_hw_set` as a reference for determining these percentiles
`days.above.99.5th` | Number of days in the heatwave above the 99.5th percentile temperature for the community
`first.in.season` | Whether the heatwave was the first to occur in its season (as determined by whether the heatwave was the first in its calendar year)
`threshold.temp` | The temperature used as the threshold for the heatwave definition in the selected community
`mean.temp.quantile` | The percentile of the average daily mean temperature during the heatwave compared to the community's year-round temperature distribution, based on the temperatures for the community during the period specified by the `referenceBoundaries` argument in `gen_hw_set`
`max.temp.quantile` | The percentile of the highest daily mean temperature during the heatwave compared to the community's year-round temperature distribution 
`min.temp.quantile` | The percentile of the lowest daily mean temperature during the heatwave compared to the community's year-round temperature distribution 
`mean.temp.1` | The community's average year-round temperature, based on the temperatures for the community during the period specified by the `referenceBoundaries` argument in `gen_hw_set`
`mean.summer.temp` | The community's average May--September temperature, based on the temperatures for the community during the period specified by the `referenceBoundaries` argument in `gen_hw_set` 
`city` | The identifier for the community, as given in the file specified in the `citycsv` argument of `gen_hw_set`.

An example of one of these dataframes is given in the `hw_datafr` dataset included with the package. This gives heatwaves projected using the r1i1p1 ensemble of NCAR's CCSM for 2061-2080, using thresholds for the heatwave definition based on present temperature distributions (1981-2004) and the temperature distributions from 2061-2080 as reference values for relative heatwave characteristics. 

You can access this data using: 

```{r}
data(hw_datafr)
```

This will load the example dataframe into your R session as the object `hw_datafr`:

```{r}
hw_datafr[1:3, c("hw.number", "mean.temp", "length", "start.date",
                 "mean.temp.quantile", "city")]
```

### Applying functions across all heatwave datasets

Once you have created a directory of files with characterized heatwaves for each ensemble member, you can explore or extend your results by using the `apply_all_models` function. This function allows you to apply custom R functions across all heatwave dataframes created by the `gen_hw_sets` call. You specify the location of the directory with the heatwave dataframes using the `out` argument when calling `apply_all_models`. Typically, this will be the same value as that for the `out` argument in `gen_hw_set`. You can apply any R function you have created, as long as it follows certain standards in accepting input and returning output.

As an example, if you wanted to to get the average length of the heatwaves identified within each ensemble member, you could write a simple function to calculate average length and then use `apply_all_models` to apply it across the dataframes for heatwaves for all ensemble members in all climate models: 

```{r, eval = FALSE}
# Define the function
average_length <- function(hw_datafr){
        ave_length <- mean(hw_datafr$length)
        return(ave_length)
}
```

```{r, eval = FALSE}
# Apply across all heatwave dataframes from all ensemble members
apply_all_models(out = "results", 
                 FUN = average_length)
```

```
  model ensemble    value
1  bcc1        1 9.830108
2  ccsm        1 9.673943
3  ccsm        2 8.795396
```

You can also use the `city_specific` argument in `apply_all_models` to apply the function separately by community. For example: 

```{r, eval = FALSE}
apply_all_models(out = "results", 
                 FUN = average_length,
                 city_specific = TRUE)
```

```
   model ensemble city     value
1   bcc1        1 balt  5.196078
2   bcc1        1  nwk  9.287037
3   bcc1        1   ny  9.287037
4   bcc1        1 phil  5.196078
5   bcc1        1 prov 33.444444
6   ccsm        1 balt  8.192308
7   ccsm        1  nwk 10.060811
8   ccsm        1   ny 10.060811
9   ccsm        1 phil  9.739437
10  ccsm        1 prov 10.446043
11  ccsm        2 balt  7.083333
12  ccsm        2  nwk  9.455128
13  ccsm        2   ny  9.455128
14  ccsm        2 phil  8.128049
15  ccsm        2 prov 10.181159
```

To work, the functions you apply using `apply_all_models` must follow a certain structure. They must require only a dataframe of heatwaves, in the format of those output by `gen_hw_set`, as the input, and they must output a single-value vector (i.e., a vector of length one).

We have included several functions as simple examples of the type of functions that can be used with `apply_all_models`: 

- `number_of_heatwaves`: Determines the number of heatwaves ; 
- `heatwave_days`: Sums up the total number of heatwave days by adding the lengths of all heatwaves; 
- `average_length`: Calculates the average length of heatwaves; and 
- `average_mean_temp`: Calculates the average mean temperature across all heatwaves

You can see the code of any of these functions, to use to develop your own, by typing just the function name (with no parentheses) in your R console. 

```{r, eval = FALSE}
average_mean_temp
```

```
function(hw_datafr){
        out <- mean(hw_datafr$mean.temp)
        return(out)
}
<environment: namespace:futureheatwaves>
```

You can use this functionality to either explore characteristics of the identified heatwaves or to estimate the health impacts of the identified heatwaves. 

To help users create their own functions, we have included an example dataframe representative of the heatwave dataframes that `gen_hw_set` outputs. This data can be loaded using the call: 

```{r eval = FALSE}
data(hw_datafr)
```

### Mapping grid points

The package also has a function that allows you to plot the locations of grid points for each climate model that match study communities, as well as show the links between climate grid points and associated communities. The `map_grid` function allows you to specify a model (`plot_model`), as well as the location of your output directory (usually, this will be the directory specified using the `out` argument in `gen_hw_set`) and will create a plot of the model grid points associated with your community locations, as well as draw lines between each community and its closest model grid point for that climate model: 

```{r fig.width = 5, message = FALSE, warning = FALSE}
out <- system.file(package = "futureheatwaves")
map_grid(plot_model = "bcc1", out = out)
```

If you want to plot several of these maps for different climate models and then plot them together, you can use the `grid.arrange` function from the `gridExtra` package: 

```{r fig.width = 5, fig.height = 7}
library(gridExtra)
a <- map_grid(plot_model = "bcc1", out = out)
b <- map_grid(plot_model = "ccsm", out = out)
grid.arrange(a, b, ncol = 1)
```

## Using custom options

A strength of this package is that it allows extensive customization by the user. This section describes which features can be customized and how. 

### Using a custom heatwave definition

A variety of different heatwave definitions have been used to identify heatwaves in a time series of temperature data [@smith2013]. Researchers might want to use a specific definition, for example, because it matches the definition used by local health officials to declare heat wave warnings or, in the case of health impact assessments, to match with a definition used in an epidemiologic study. 

The default is for this package to use the following definition to identify heatwaves: 

> A heatwave is two or more days at or above a community-specific threshold temperature, with the threshold determined as the $98^{th}$ percentile of year-round temperature in the community during some reference period (by default, 1981--2004).

Two components of this definition can be easily customized, without creating a new R function to use to identify heatwaves. With a bit more work, in terms of writing a custom R function, the customization of the heatwave definition is almost limitless.

First, the percentile used to identify a heatwave can be changed using the `probThreshold` option when calling the `gen_hw_set` function. This option can take values between 0 and 1. The default value is 0.98, or a definition with a threshold of the $98^{th}$ percentile of the community's temperature.

Second, it is possible to specify the range of years of data for the community that should be used when determining this threshold. For example, if you wanted to base the threshold for each community on current community climates, you could leave this option as its default, which uses climate projections from the years 1981 to 2004 to determine the thresholds. If you wanted to use a different set of years, you could set the start and end year
bounds for this reference period within the first two values of the option `dataBoundaries` in the function `gen_hw_set`.

It is also possible to use a completely customized heatwave definition. To do this, you will need to write and load a function that implements your chosen heatwave definition. You can then reference the custom function using the `IDheatwavesFunction` option in `gen_hw_set`. To work correctly, this custom function must allow only specific inputs and generate only specific outputs. 

The function must allow the following inputs (even if it does not use them within the function code):

- `datafr`: A dataframe with columns for date and temperature for a community. The first column should be the date of each observation, in the Date class. The second column should be the temperature. At this point in the normal processing of the `gen_hw_set` function, temperatures have been converted from Kelvin (the expected units for the climate projection files) to Fahrenheit. Therefore, if you are writing a custom function that uses an absolute temperature threshold, it should be included in the function in Fahrenheit units.
- `threshold`: A single-value numerical vector; in the default definition, this is the threshold temperature for each community, as determined earlier in the function call, calculated as a percentile of the community's year-round temperature.

The function must return only the input dataframe (`datafr`), with the following columns added: 

- `hw`: A binary variable indicating whether a day was part of a heatwave (1: day in a heatwave; 0: not in a heatwave) and
- `hw.number`: A non-negative integer that is 0 for all days that are not in heatwaves and, for days in heatwaves, gives a unique number for each separate heatwave. For example, all days in the second heatwaves in the time series would get the value 2 for this column, while all days in the fifth heatwave would get the value 5, and all days not in heatwaves would get the value 0. 

To help in developing your own heatwave identification functions, the package includes an example of the required input dataframe, `datafr`. You can load this dataframe by calling: 

```{r}
data(datafr)
```

If your heatwave function is properly set up to use in this package, it can take as input this example dataframe and a threshold value and will return the original dataframe with the columns `hw` and `hw.number`, as defined above, returned:

```{r}
head(datafr, 3)
id_of_hws <- IDHeatwavesR(datafr = datafr, threshold = 95)
head(id_of_hws, 3)
```

The custom function can then be referenced using the `IDheatwavesFunction` option in `gen_hw_set`, and it will be used to identify heatwaves in the dataset. You should specify the function name in quotation marks for this argument. For example, we have included an alternative ID definition function in this package, called `IDHeatwavesAlternative`, which identifies heatwaves as five or more days (compared to two or more days required by the default definition) above a community's $98^{th}$ percentile temperature. To use this as the heatwave definition, you would run:

```{r, eval = FALSE}
# Set up path names to example data
projection_dir_location <- system.file("cmip5", package = "futureheatwaves")
city_file_location <- system.file("cities.csv", package = "futureheatwaves")

gen_hw_set(out = "example_results",
           dataFolder = projection_dir_location ,
           dataDirectories = list("historical" = c(1980, 2004),
                                        "rcp85" = c(2006, 2099)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_NorthAmerica_12mo.csv",
           tasFilenames = "tas_NorthAmerica_12mo.csv",
           timeFilenames = "time_NorthAmerica_12mo.csv",
           lat_lon_colnames = c("lat", "long"),
           IDheatwavesFunction = "IDHeatwavesAlternative")
```

### Customizing projection dates

By default, the function will generate heatwave projections for the selected communities for the years 2061 to 2080. This projection date range can be changed by specifying alternative starting and ending years as the third and fourth values of the `projectionBoundaries` option in the `gen_hw_set` function. The starting year cannot be earlier than the starting date specified for the first subdirectory (e.g., "historical") or later than the last date of the second subdirectory (e.g., "rcp85"). Further, the custom date boundaries cannot span between the two subdirectories.

For example, to create projections for 2071 to 2090, you could call: 

```{r, eval = FALSE}
gen_hw_set(out = "example_results",
           dataFolder = projection_dir_location ,
           dataDirectories = list("historical" = c(1980, 2004),
                                        "rcp85" = c(2006, 2099)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_NorthAmerica_12mo.csv",
           tasFilenames = "tas_NorthAmerica_12mo.csv",
           timeFilenames = "time_NorthAmerica_12mo.csv",
           lat_lon_colnames = c("lat", "long"),
           IDheatwavesFunction = "IDHeatwavesAlternative",
           projectionBoundaries = c(2071, 2090))
```

### Customizing dates used to determine thresholds or reference data

Similarly, while the default is to use data from 1981 to 2004 to determine the threshold temperature for each community's heatwave definition, the user can customize which date range to use when pulling the temperature data to use to calculate these thresholds. This option is specified using the `thresholdBoundaries` option in `gen_hw_set`. For example, to use the years 2061 to 2080 to calculate these threshold temperatures, you could run: 

```{r, eval = FALSE}
gen_hw_set(out = "example_results",
           dataFolder = projection_dir_location ,
           dataDirectories = list("historical" = c(1980, 2004),
                                        "rcp85" = c(2006, 2099)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_NorthAmerica_12mo.csv",
           tasFilenames = "tas_NorthAmerica_12mo.csv",
           timeFilenames = "time_NorthAmerica_12mo.csv",
           lat_lon_colnames = c("lat", "long"),
           IDheatwavesFunction = "IDHeatwavesAlternative",
           thresholdBoundaries = c(2061, 2080))
```

You can customize one other set of time boundaries. The heatwave datasets include several heatwave characteristics that incorporate relative temperature. These take the absolute temperature measures of heatwave and compare them to the community's typical temperature distributions to generate relative measures of the intensity of the heatwave. The default is to use temperatures from a community for the period 2061 to 2080 for these reference temperatures to calculate relative temperatures of each heatwave. However, you can use the `referenceBoundaries` option of `gen_hw_set` to specify which years you would like to use for these reference temperatures. This can be useful in exploring the role of adaptation in future heatwaves. For example, if you wanted to use temperature projections for 2031 to 2040 when calculating relative characteristics of heatwaves, you could run: 

```{r, eval = FALSE}
gen_hw_set(out = "example_results",
           dataFolder = projection_dir_location ,
           dataDirectories = list("historical" = c(1980, 2004),
                                        "rcp85" = c(2006, 2099)),
           citycsv = city_file_location,
           coordinateFilenames = "latitude_longitude_NorthAmerica_12mo.csv",
           tasFilenames = "tas_NorthAmerica_12mo.csv",
           timeFilenames = "time_NorthAmerica_12mo.csv",
           lat_lon_colnames = c("lat", "long"),
           IDheatwavesFunction = "IDHeatwavesAlternative",
           referencdeBoundaries = c(2031, 2040))
```

As with the `projectionBoundaries` option, there are some restrictions on which year ranges can be selected. The starting year cannot be earlier than the first year in the first subdirectory and the ending year cannot be later than the last year of the second subdirectory. Further, the custom date boundaries cannot span the two directories.

## How the package works

### Parsing the directory structure

The function reads in the structure of the directory specified by `dataFolder` and uses the names of subdirectories to create a list of all of the climate models and their ensemble members within the directory. 

The function that does this parsing, `acquireDirectoryStructure`, returns a list object outlining the file structure of the directory containing the climate projections. This list has an element for each climate model (e.g. ,"ccsm"). The first element within each of these elements is the name of the model. The second element within the first-level element gives the file paths for location grids, climate projections, and projection times for each ensemble run of the model.

This parsed version of the directory structure allows later functions to walk through all of the climate projections for different models and ensembles within the specified projections directory.

If you only specify some of the models to run, this part of the package will prune any unneeded models from the parsed directory structure before proceeding with the rest of the functions.

### Determining thresholds for heatwave definition

To determine the threshold value for each community, the function pulls climate projection data from either the default historical years (1981--2004) or from a customized range of dates, as specified by the first two values in the `dataBoundaries` option for the `gen_hw_set` function. This option allows the user to select years to use when determining these threshold temperatures.

All climate projection data for the grid point closest to each community is pulled and use to estimate the community-specific thresholds. The percentile value calculated for each community is either a default of 0.98 or is specified by the user using the `probThreshold` option in the `gen_hw_set` function.

These community-specific thresholds are then passed through to later calls in the function, where they are used to identify heatwaves in a time series of climate projection data. 

### Identifying heatwaves in an ensemble member's projection data

...

### Characterizing heatwaves

...

### Aggregating heatwave projections

Once the function has generated a list describing the climate models and ensemble members included in the user-specified `dataFolder` directory of climate projections, the function will run through all ensemble members of any climate model within this directory, identify and characterize the heatwaves for that ensemble member, and save the resulting dataframe to output. 

The package uses closures to aggregate data over all the different ensemble members of all climate models included in the directory of projection data ...

### Writing out results to the user's local computer

...

### Applying user-specified functions across all heatwave datasets

...

## Caveats

- Heatwaves near the start / end of the dataset
- Downscaling

## Possible future developments

- Allowing netCDF for input files
- Allowing to specify exact date for boundaries, not year (would allow easier use for southern hemisphere-- reduce problems with "edge-case" heatwaves)

## References
